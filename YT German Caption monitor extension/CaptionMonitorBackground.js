// background.js
// From captionMonitorContentScript.js file, start here:
let germanWordListObject = {"wie":"like","ich":"i","seine":"his","dass":"that","er":"he","war":"was","für":"for","auf":"toward","sind":"are","mit":"with","sie":"her","sein":"be","bei":"in","ein":"an","haben":"have","dies":"this","aus":"off","durch":"through","heiß":"hot","wort":"word","aber":"but","was":"what","einige":"some","ist":"is","es":"it","oder":"or","hatte":"had","die":"who","von":"of","zu":"too","und":"and","wir":"we","können":"may","andere":"other","waren":"were","tun":"do","ihre":"your","zeit":"period","wenn":"when","werden":"will","sagte":"told","jeder":"every","sagen":"say","tut":"does","satz":"sentence","drei":"three","wollen":"want","luft":"air","gut":"good","auch":"even","spielen":"play","klein":"small","ende":"end","setzen":"put","zuhause":"home","lesen":"read","seits":"hand","hafen":"port","groß":"grand","buchstabieren":"spell","hinzufügen":"add","lande":"land","hier":"here","muss":"must","hoch":"tall","so":"thus","folgen":"follow","akt":"act","warum":"why","fragen":"ask","männer":"men","veränderung":"change","ging":"went","licht":"light","art":"kind","müssen":"need","haus":"house","bild":"picture","versuchen":"try","uns":"us","wieder":"again","tier":"animal","punkt":"point","mutter":"mother","welt":"world","in der nähe von":"near","bauen":"build","selbst":"self","erde":"planet","vater":"father","neu":"new","arbeit":"job","teil":"part","nehmen":"take","erhalten":"get","ort":"place","gemacht":"made","leben":"life","wo":"where","nach":"post","zurück":"back","wenig":"little","nur":"just","runde":"round","mann":"man","jahr":"year","kam":"came","zeigen":"indicate","mir":"me","geben":"give","unsere":"our","unter":"among","name":"name","sehr":"very","formular":"form","denken":"think","hilfe":"help","niedrig":"low","linie":"line","abweichen":"differ","wiederum":"turn","ursache":"cause","viel":"deal","bedeuten":"mean","vor":"ago","umzug":"move","recht":"right","junge":"boy","alt":"old","gleich":"equal","alle":"all","da":"there","nach oben":"up","verwendung":"use","weg":"path","über":"over","viele":"many","dann":"then","schreiben":"letter","würde":"would","diese":"these","lange":"long","machen":"make","sache":"thing","sehen":"see","ihm":"him","zwei":"two","hat":"has","suchen":"look","mehr":"more","tag":"day","könnte":"could","gehen":"walk","kommen":"come","tat":"did","anzahl":"number","klingen":"sound","nicht":"no","am meisten":"most","menschen":"people","meine":"my","wissen":"know","wasser":"water","als":"than","anruf":"call","erste":"first","nach unten":"down","seite":"page","gewesen":"been","jetzt":"now","finden":"find","kopf":"head","stehen":"stand","besitzen":"own","sollte":"should","land":"country","gefunden":"found","antwort":"answer","schule":"school","wachsen":"grow","studie":"study","noch":"nor","lernen":"learn","anlage":"plant","abdeckung":"cover","lebensmittel":"food","sonne":"sun","vier":"four","zwischen":"between","zustand":"condition","halten":"hold","auge":"eye","nie":"never","letzte":"last","lassen":"let","gedanken":"thought","stadt":"town","baum":"tree","überqueren":"cross","bauernhof":"farm","schwer":"heavy","beginn":"start","macht":"power","geschichte":"history","säge":"saw","weit":"far","meer":"sea","ziehen":"pull","links":"left","spät":"late","laufen":"run","unterlassen sie":"don’t","während":"during","presse":"press","schließen":"close","nacht":"night","realen":"real","wenige":"few","norden":"north","buch":"book","tragen":"wear","nahm":"took","wissenschaft":"science","essen":"eat","zimmer":"room","freund":"friend","begann":"began","idee":"idea","fisch":"fish","berg":"mount","stopp":"stop","einmal":"once","basis":"basic","hören":"listen","pferd":"horse","schnitt":"cut","sicher":"safe","beobachten":"observe","farbe":"color","gesicht":"face","holz":"wood","haupt-":"main","geöffnet":"open","scheinen":"seem","zusammen":"together","nächste":"next","weiß":"white","kinder":"children","start":"begin","bekam":"got","beispiel":"example","erleichtern":"ease","papier":"paper","gruppe":"group","immer":"always","musik":"music","diejenigen":"those","beide":"both","marke":"mark","oft":"often","bis":"until","meile":"mile","fluss":"river","auto":"car","füße":"feet","pflege":"care","zweite":"second","genug":"enough","ebene":"level","mädchen":"girl","üblich":"usual","jung":"young","bereit":"ready","oben":"above","je":"ever","rot":"red","liste":"list","obwohl":"though","fühlen":"feel","vortrag":"talk","vogel":"bird","bald":"soon","körper":"body","hund":"dog","familie":"family","direkt":"direct","pose":"pose","verlassen":"leave","lied":"song","messen":"measure","tür":"door","produkt":"product","schwarz":"black","kurz":"short","zahl":"numeral","klasse":"class","wind":"wind","frage":"question","passieren":"pass","vollständig":"complete","schiff":"ship","bereich":"area","hälfte":"half","stein":"stone","bestellen":"order","feuer":"fire","süden":"south","problem":"problem","stück":"piece","wusste":"knew","seit":"since","obere":"top","ganze":"whole","könig":"king","straße":"road","zoll":"inch","multiplizieren":"multiply","nichts":"nothing","kurs":"course","bleiben":"stay","rad":"wheel","voll":"full","kraft":"force","blau":"blue","objekt":"object","entscheiden":"decide","oberfläche":"surface","tief":"deep","mond":"moon","insel":"island","fuß":"foot","system":"system","beschäftigt":"busy","prüfung":"test","rekord":"record","boot":"boat","gemeinsam":"common","goldenen":"gold","möglich":"possible","flugzeug":"plane","statt":"stead","trocken":"dry","wunder":"wonder","lachen":"laugh","tausend":"thousand","lief":"ran","überprüfen":"check","spiel":"match","form":"shape","gleichsetzen":"equate","fehl":"miss","gebracht":"brought","wärme":"heat","schnee":"snow","reifen":"tire","bringen":"bring","ja":"yes","entfernt":"distant","füllen":"fill","osten":"east","malen":"paint","sprache":"language","einheit":"unit","fein":"fine","fliegen":"fly","fallen":"drop","führen":"guide","schrei":"shout","dunkel":"dark","maschine":"machine","note":"note","warten":"wait","plan":"plan","abbildung":"figure","stern":"star","kasten":"box","nomen":"noun","feld":"field","rest":"rest","richtig":"proper","fähig":"able","pfund":"pound","getan":"done","schönheit":"beauty","antriebs":"drive","stand":"stood","enthalten":"contain","front":"front","lehren":"teach","woche":"week","finale":"final","gab":"gave","grün":"green","oh":"oh","schnell":"fast","entwickeln":"develop","ozean":"ocean","warme":"warm","kostenlos":"free","minute":"minute","stark":"strong","besondere":"particular","geist":"mind","hinter":"behind","klar":"clear","schwanz":"tail","produzieren":"produce","tatsache":"fact","raum":"space","gehört":"heard","beste":"best","stunde":"hour","besser":"better","wahr":"true","hundert":"hundred","fünf":"five","merken":"remember","schritt":"step","früh":"early","westen":"west","boden":"soil","interesse":"interest","erreichen":"reach","verbum":"verb","singen":"sing","sechs":"six","tabelle":"chart","reise":"trip","weniger":"less","morgen":"morning","zehn":"ten","einfach":"simple","mehrere":"several","vokal":"vowel","krieg":"war","legen":"lay","gegen":"against","muster":"pattern","schleppend":"slow","zentrum":"center","liebe":"dear","person":"person","geld":"money","dienen":"serve","erscheinen":"appear","karte":"card","regen":"rain","regel":"rule","regieren":"govern","kälte":"cold","hinweis":"notice","stimme":"voice","energie":"energy","jagd":"hunt","wahrscheinlich":"probable","bett":"bed","bruder":"brother","ei":"egg","fahrt":"ride","zelle":"cell","glauben":"believe","vielleicht":"perhaps","pflücken":"pick","plötzlich":"sudden","zählen":"count","platz":"square","grund":"reason","dauer":"length","vertreten":"represent","kunst":"art","thema":"subject","region":"region","größe":"size","variieren":"vary","regeln":"settle","sprechen":"speak","gewicht":"weight","allgemein":"general","eis":"ice","materie":"matter","kreis":"circle","paar":"pair","umfassen":"include","kluft":"divide","silbe":"syllable","filz":"felt","kugel":"ball","welle":"wave","herz":"heart","uhr":"clock","vorhanden":"present","tanz":"dance","motor":"engine","position":"position","arm":"poor","breit":"broad","segel":"sail","material":"material","fraktion":"fraction","wald":"forest","sitzen":"sit","rennen":"race","fenster":"window","speicher":"store","sommer":"summer","zug":"train","schlaf":"sleep","beweisen":"prove","einsam":"lone","bein":"leg","übung":"exercise","wand":"wall","fang":"catch","wünschen":"wish","himmel":"sky","board":"board","freude":"joy","winter":"winter","sa":"sat","geschrieben":"written","wilden":"wild","instrument":"instrument","gehalten":"kept","glas":"glass","gras":"grass","kuh":"cow","rand":"edge","zeichen":"symbol","besuch":"visit","vergangenheit":"past","weich":"soft","spaß":"fun","hell":"bright","gases":"gas","wetter":"weather","monat":"month","million":"million","finish":"finish","glücklich":"happy","hoffen":"hope","blume":"flower","kleiden":"clothe","seltsam":"strange","vorbei":"gone","handel":"trade","melodie":"melody","büro":"office","empfangen":"receive","reihe":"row","mund":"mouth","genau":"exact","sterben":"die","am wenigsten":"least","ärger":"trouble","außer":"except","schrieb":"wrote","samen":"seed","ton":"tone","beitreten":"join","vorschlagen":"suggest","sauber":"clean","pause":"break","dame":"lady","hof":"yard","steigen":"rise","schlecht":"bad","schlag":"blow","öl":"oil","blut":"blood","berühren":"touch","wuchs":"grew","cent":"cent","mischen":"mix","mannschaft":"team","draht":"wire","kosten":"cost","verloren":"lost","braun":"brown","garten":"garden","gesendet":"sent","wählen":"select","fiel":"fell","passen":"fit","fließen":"flow","messe":"fair","bank":"bank","sammeln":"gather","sparen":"save","kontrolle":"control","dezimal":"decimal","ohr":"ear","sonst":"else","ganz":"quite","pleite":"broke","fall":"case","mitte":"middle","töten":"kill","sohn":"son","see":"lake","moment":"moment","maßstab":"scale","laut":"loud","frühling":"spring","kind":"baby","gerade":"straight","konsonant":"consonant","nation":"nation","wörterbuch":"dictionary","milch":"milk","geschwindigkeit":"speed","verfahren":"method","orgel":"organ","zahlen":"pay","alter":"age","abschnitt":"section","kleid":"dress","wolke":"cloud","überraschung":"surprise","ruhig":"quiet","winzig":"tiny","aufstieg":"climb","kühlen":"cool","entwurf":"design","menge":"crowd","versuch":"experiment","schlüssel":"key","eisen":"iron","einzel":"single","stick":"stick","wohnung":"flat","zwanzig":"twenty","haut":"skin","lächeln":"smile","falte":"crease","loch":"hole","springen":"jump","acht":"eight","dorf":"village","treffen":"hit","wurzel":"root","kaufen":"buy","erhöhen":"raise","lösen":"solve","metall":"metal","ob":"whether","drücken":"push","sieben":"seven","absatz":"paragraph","dritte":"third","wird":"shall","hand":"held","haar":"hair","beschreiben":"describe","koch":"cook","entweder":"either","ergebnis":"result","brennen":"burn","hügel":"hill","katze":"cat","jahrhundert":"century","betrachten":"consider","typ":"type","gesetz":"law","bit":"bit","küste":"coast","kopie":"copy","ausdruck":"phrase","still":"silent","sand":"sand","rolle":"roll","temperatur":"temperature","finger":"finger","industrie":"industry","wert":"value","kampf":"fight","lüge":"lie","schlagen":"beat","begeistern":"excite","natürlich":"natural","blick":"sight","sinn":"sense","hauptstadt":"capital","wird nicht":"won’t","stuhl":"chair","achtung":"danger","obst":"fruit","reich":"rich","dick":"thick","soldat":"soldier","prozess":"process","betreiben":"operate","praxis":"practice","trennen":"separate","schwierig":"difficult","arzt":"doctor","bitte":"please","schützen":"protect","mittag":"noon","ernte":"crop","modernen":"modern","elementes":"element","schüler":"student","ecke":"corner","partei":"party","versorgung":"supply","deren":"whose","lokalisieren":"locate","rings":"ring","charakter":"character","insekt":"insect","gefangen":"caught","funk":"radio","speiche":"spoke","atom":"atom","mensch":"human","wirkung":"effect","elektrisch":"electric","erwarten":"expect","knochen":"bone","schiene":"rail","vorstellen":"imagine","bieten":"provide","zustimmen":"agree","sanft":"gentle","frau":"wife","kapitän":"captain","erraten":"guess","erforderlich":"necessary","scharf":"sharp","flügel":"wing","schaffen":"create","nachbar":"neighbor","wasch":"wash","fledermaus":"bat","eher":"rather","mais":"corn","vergleichen":"compare","gedicht":"poem","schnur":"string","glocke":"bell","abhängen":"depend","fleisch":"meat","einreiben":"rub","rohr":"tube","berühmt":"famous","dollar":"dollar","strom":"current","angst":"fear","dünn":"thin","dreieck":"triangle","eile":"hurry","chef":"chief","kolonie":"colony","mine":"mine","krawatte":"tie","eingeben":"enter","dur":"major","frisch":"fresh","suche":"search","senden":"send","gelb":"yellow","pistole":"gun","erlauben":"allow","druck":"print","tot":"dead","stelle":"spot","wüste":"desert","anzug":"suit","aufzug":"lift","stiegen":"rose","ankommen":"arrive","stamm":"master","spur":"track","elternteil":"parent","ufer":"shore","teilung":"division","blatt":"sheet","substanz":"substance","begünstigen":"favor","verbinden":"connect","verbringen":"spend","akkord":"chord","fett":"fat","froh":"glad","original":"original","aktie":"share","station":"station","papa":"dad","brot":"bread","aufladen":"charge","leiste":"bar","angebot":"range","segment":"segment","sklave":"slave","ente":"duck","augenblick":"instant","markt":"market","grad":"degree","besiedeln":"populate","küken":"chick","feind":"enemy","antworten":"reply","getränk":"drink","auftreten":"occur","unterstützung":"support","rede":"speech","natur":"nature","dampf":"steam","bewegung":"motion","flüssigkeit":"liquid","protokollieren":"log","gemeint":"meant","quotient":"quotient","gebiss":"teeth","schale":"shell","hals":"neck","sauerstoff":"oxygen","zucker":"sugar","tod":"death","ziemlich":"pretty","geschicklichkeit":"skill","frauen":"women","saison":"season","lösung":"solution","magnet":"magnet","silber":"silver","danken":"thank","zweig":"branch","suffix":"suffix","insbesondere":"especially","feige":"fig","ängstlich":"afraid","riesig":"huge","schwester":"sister","stahl":"steel","diskutieren":"discuss","vorwärts":"forward","ähnlich":"similar","erfahrung":"experience","partitur":"score","apfel":"apple","gekauft":"bought","geführt":"led","tonhöhe":"pitch","mantel":"coat","masse":"mass","band":"band","seil":"rope","rutsch":"slip","gewinnen":"win","träumen":"dream","abend":"evening","futtermittel":"feed","werkzeug":"tool","gesamt":"total","geruch":"smell","tal":"valley","doppelt":"double","sitz":"seat","fortsetzen":"continue","block":"block","hut":"hat","verkaufen":"sell","erfolg":"success","firma":"company","subtrahieren":"subtract","veranstaltung":"event","schwimmen":"swim","begriff":"term","gegenteil":"opposite","schuh":"shoe","schulter":"shoulder","verbreitung":"spread","arrangieren":"arrange","lager":"camp","erfinden":"invent","baumwolle":"cotton","geboren":"born","bestimmen":"determine","quart":"quart","neun":"nine","lastwagen":"truck","lärm":"noise","chance":"chance","geschäft":"shop","stretch":"stretch","werfen":"throw","glanz":"shine","immobilien":"property","spalte":"column","molekül":"molecule","falsch":"wrong","grau":"gray","wiederholung":"repeat","erfordern":"require","vorbereiten":"prepare","salz":"salt","nase":"nose","mehreren":"plural","zorn":"anger","anspruch":"claim","kontinent":"continent"}

let processedList = {}

// it will extract unique words from an array or string
function extractUniqueWords(input) {
    let words;
    
    if (typeof input === 'string') {
      words = input.toLowerCase().split(/\W+/);
    } else if (Array.isArray(input)) {
      words = input.map(item => item.toLowerCase());
    } else {
      throw new Error('Input must be a string or an array.');
    }
    
    const uniqueWords = [...new Set(words)];
    return uniqueWords;
  }

// it will replace words you want to replace with new words preserving case.
function replaceWord(sentence, oldWord, newWord) {
    // Create a regular expression that matches the old word surrounded by word boundaries
    var regex = new RegExp("\\b" + oldWord + "\\b", "gi");
    
    // Function to preserve the case of the original word
    var replacer = function(match) {
      if (match === oldWord) {
        return newWord;
      } else if (match === oldWord.charAt(0).toUpperCase() + oldWord.slice(1)) {
        return newWord.charAt(0).toUpperCase() + newWord.slice(1);
      } else {
        return newWord.toLowerCase();
      }
    };
    
    // Use the replace method with the regex and replacer function to replace all instances of the old word
    var newSentence = sentence.replace(regex, replacer);
    
    return newSentence;
   }
   

// this function replace whitespace with underscores of a sentence
function replaceSpacesWithUnderscores(sentence) {
  return sentence.replace(/[^a-zA-Z0-9\u00C0-\u00FF]/g, '_');
}


// as directly modifying the captions has its drawbacks,  the same translated captions are fetched and sent to background for translation again, to prevent this, we are keeping a record
function checkProcessedList(sentence){
    if(processedList[replaceSpacesWithUnderscores(sentence)] || Object.values(processedList).includes(sentence)){
        console.log('found in processedlist')
        return sentence
    } else {
        let wordsToFind = extractWords(sentence)
        let newSentence = findGermanMeaning(wordsToFind, sentence)
        processedList[replaceSpacesWithUnderscores(sentence)] = newSentence
        console.log(processedList)
        return newSentence
    }
}

// this function would extract words only out of a string, while excluding all special characters and spaces and return them as an array
function extractWords(str) {
    // Remove special characters and numbers
    const cleanedStr = str.replace(/[^\p{L}\s]/gu, '');
  
    // Split the cleaned string into an array of words
    const words = cleanedStr.split(/\s+/).filter(word => word !== '');
  
    return extractUniqueWords(words);
  }


//   here the parameter is an array which the words that need to be translated and the german word list
// function findGermanMeaning(wordsToFind, rawSentence){
//     let translatedSentence = rawSentence
//     // make it efficient
//     console.log(wordsToFind, ': total words to find.')
//     wordsToFind.forEach((word)=>{
//         if(germanWordList.includes(word.toLowerCase())){
//             // every time the raw sentence is getting output
//                 translatedSentence = replaceWord(translatedSentence, word, `${word}(${germanWordList[germanWordList.indexOf(word.toLowerCase())+1]})`)
//                 console.log(`${word} exists: ${translatedSentence}`, translatedSentence, word)            
//             } else{
//                 console.log(`${word} doesn't exists.`)
//             }
//     })

//     return translatedSentence.trim()   
// }

//   here the parameter is an array which the words that need to be translated and the german word list
function findGermanMeaning(wordsToFind, rawSentence){
    let translatedSentence = rawSentence
    // make it efficient
    console.log(wordsToFind, ': total words to find.')
    wordsToFind.forEach((word)=>{
        if(!!(germanWordListObject[word.toLowerCase()])){
            // every time the raw sentence is getting output
                translatedSentence = replaceWord(translatedSentence, word, `${word}(${germanWordListObject[word.toLowerCase()]})`)
                console.log(`${word} exists: ${translatedSentence}`, translatedSentence, word)            
            } else{
                console.log(`${word} doesn't exists.`)
            }
    })

    return translatedSentence.trim()   
}


// listen for messages
chrome.runtime.onMessage.addListener((message, sender, sendResponse)=>{
    // From captionMonitorContentScript line: 45
    console.log(message.message.trim(), 'from background 1105 line')
    sendResponse({message: checkProcessedList(message.message.trim())})
})


// From captionMonitorContentScript.js file, stops here 
